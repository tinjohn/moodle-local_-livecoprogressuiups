{"version":3,"file":"cm_h5p_scored_listener.min.js","sources":["../../../src/local/listener/cm_h5p_scored_listener.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Dynamic Progressbar and more - JS code cm_h5p_scored_listener\n *\n * @module     local_livecoprogressuiups/cm_h5p_scored_listener\n * @copyright  2023 Tina John <tina.john@th-luebeck.de>\n * @copyright  Institut fuer interaktive Systeme der TH LÃ¼beck\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n//import {get_H5P_ActivityInformation_InnerHTML} from './repository';\n\n\nlet registered = false;\n\n/**\n * Function to intialise and register event listeners for this module.\n */\nexport const init = () => {\n    if (registered) {\n        return;\n    }\n    registered = true;\n\n\n    /**\n    * USED for handleXAPIEvent\n    * Add progress whenever context.id module was not completed on inital load.\n    * @param {event} event from Dispatcher.\n    */\n    const handleXAPIEvent = function (event) {\n        if (event && event.data && event.data.statement && event.data.statement.result) {\n            if (event.data.statement.result.score && event.data.statement.result.score.scaled) {\n                // window.console.log('lcprogessuiups-- --externalDispatcher-handleXAPIEvent-', event);\n                const theiframe = this.frameElement;\n                // Create and trigger the cmcompleted event listened by dynprogress.\n                var cmcompletedEvent = new CustomEvent('cmcompleted',\n                    {\n                        detail: {\n                            completionType: 'H5Pscored',\n                            framedin: theiframe,\n                            message: 'a course module completed or scored'\n                        }\n                    });\n                document.dispatchEvent(cmcompletedEvent);\n            }\n        }\n    };\n\n\n    // Listen to H5P iframe message to get H5P completion statements.\n    window.addEventListener('message', function (e) {\n        // window.console.log('lcprogessuiups-- ---got mail from iframe---', e.data);\n        // iframe is loaded and all namesspaces are load\n        if (e.data && e.data.context) {\n            if (e.data.context == \"h5p\" && e.data.action == \"hello\") {\n                addsh5pdispatcherlistener();\n            }\n        }\n    });\n\n\n    /**\n    * addsh5pdispatcherlistener\n    * Add progress whenever context.id module was not completed on inital load.\n    */\n    function addsh5pdispatcherlistener() {\n        // FOLLOWING  WORKING BUT TO early in the event lists - setTimeout is a workaround\n        // document.onreadystatechange: iframe is loaded and all namesspaces are loaded\n        // DOES NOT work for single H5P in a course, thus allow multiple listeners to be removed again\n\n        // The single H5P.\n        if (window.document.h5player\n            && window.document.h5player.H5P && window.document.h5player.H5P.externalDispatcher) {\n            // window.console.log('lcprogessuiups-- livecoprogressuiups--externalDispatcher-single-gefunden-aka_docready-');\n\n            var h5pextlDispatcher = window.document.h5player.H5P.externalDispatcher;\n            // delete all listeners from H5P.externalDispatcher to get rid of double executions\n            // without function due to error with given function as argument\n            window.document.h5player.H5P.externalDispatcher.off('xAPI');\n            window.document.h5player.H5P.externalDispatcher.on('xAPI', handleXAPIEvent.bind(window.document.h5player));\n        } else {\n            // Access the h5pplayer within each window.\n            for (var i = 0; i < window.length; i++) {\n                var currentWindow = window[i];\n                // ADDED tinjohn 03.06.2024 there might be other layers.\n                if (currentWindow.length > 0) {\n                    if (currentWindow.name == \"h5player\") {\n                        h5pextlDispatcher = currentWindow.H5P.externalDispatcher;\n                        if (h5pextlDispatcher) {\n                            // window.console.log(\"lcprogessuiups-----found h5p in window ---\", h5pextlDispatcher);\n                            // Delete all listeners from H5P.externalDispatcher to get rid of double executions\n                            // without function due to error with given function as argument\n                            // tried a lot to make it work with function - no success.\n                            currentWindow.H5P.externalDispatcher.off('xAPI');\n                            currentWindow.H5P.externalDispatcher.on('xAPI', handleXAPIEvent.bind(currentWindow));\n                        } else {\n                            // window.console.log('lcprogessuiups-- livecoprogressuiups--h5playerElement not found');\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n};\n"],"names":["registered","handleXAPIEvent","event","data","statement","result","score","scaled","theiframe","this","frameElement","cmcompletedEvent","CustomEvent","detail","completionType","framedin","message","document","dispatchEvent","window","addEventListener","e","context","action","h5player","H5P","externalDispatcher","off","on","bind","i","length","currentWindow","name","addsh5pdispatcherlistener"],"mappings":";;;;;;;;;IA2BIA,YAAa,gBAKG,QACZA,kBAGJA,YAAa,QAQPC,gBAAkB,SAAUC,UAC1BA,OAASA,MAAMC,MAAQD,MAAMC,KAAKC,WAAaF,MAAMC,KAAKC,UAAUC,QAChEH,MAAMC,KAAKC,UAAUC,OAAOC,OAASJ,MAAMC,KAAKC,UAAUC,OAAOC,MAAMC,OAAQ,OAEzEC,UAAYC,KAAKC,iBAEnBC,iBAAmB,IAAIC,YAAY,cACnC,CACIC,OAAQ,CACJC,eAAgB,YAChBC,SAAUP,UACVQ,QAAS,yCAGrBC,SAASC,cAAcP,oBAOnCQ,OAAOC,iBAAiB,WAAW,SAAUC,GAGrCA,EAAElB,MAAQkB,EAAElB,KAAKmB,SACK,OAAlBD,EAAElB,KAAKmB,SAAqC,SAAjBD,EAAElB,KAAKoB,sBAiBtCJ,OAAOF,SAASO,UACbL,OAAOF,SAASO,SAASC,KAAON,OAAOF,SAASO,SAASC,IAAIC,mBAAoB,CAG5DP,OAAOF,SAASO,SAASC,IAAIC,mBAGrDP,OAAOF,SAASO,SAASC,IAAIC,mBAAmBC,IAAI,QACpDR,OAAOF,SAASO,SAASC,IAAIC,mBAAmBE,GAAG,OAAQ3B,gBAAgB4B,KAAKV,OAAOF,SAASO,oBAG3F,IAAIM,EAAI,EAAGA,EAAIX,OAAOY,OAAQD,IAAK,KAChCE,cAAgBb,OAAOW,GAEvBE,cAAcD,OAAS,GACG,YAAtBC,cAAcC,MACMD,cAAcP,IAAIC,qBAMlCM,cAAcP,IAAIC,mBAAmBC,IAAI,QACzCK,cAAcP,IAAIC,mBAAmBE,GAAG,OAAQ3B,gBAAgB4B,KAAKG,kBAvCjFE"}