{"version":3,"file":"dynprogress.min.js","sources":["../src/dynprogress.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Dynamic Progressbar and more\n *\n * @module     local_livecoprogressuiups/dynprbar\n * @copyright  2023 Tina John <tina.john@th-luebeck.de>\n * @copyright  Institut fuer interaktive Systeme der TH LÃ¼beck\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {init as listener} from './listener';\n\nimport {get_theme_learnr_Progressbar_InnerHTML} from './local/dynprogress/repository';\nimport {get_block_Game_InnerHTML} from './local/dynprogress/repository';\nimport {get_H5P_ActivityInformation_InnerHTML} from './local/dynprogress/repository';\n\nimport selectors from 'local_livecoprogressuiups/local/dynprogress/selectors';\n\n/**\n* USED get course id from body tag.\n*/\nfunction getCourseIdFromBody() {\n    const bodyTag = document.getElementsByTagName('body')[0];\n    const attributeNames = bodyTag.getAttributeNames();\n    var courseid;\n    attributeNames.forEach(attribute => {\n        const attributeValue = bodyTag.getAttribute(attribute);\n        const regex = /course-(\\d+)/;\n        const matches = attributeValue.match(regex);\n        if (matches) {\n            const courseNumber = matches[0];\n            courseid = courseNumber.split('-')[1];\n            window.console.log(\"lcprogessuiups-- Coursenumber------\", courseid); // Output: course-64\n            return(courseid);\n        }\n    });\n    if(courseid) {\n        return(courseid);\n    } else {\n        return false;\n    }\n}\n\n/**\n *\n * @param {*} course_id\n * @returns Promise\n */\nasync function promise_get_theme_learnr_Progressbar_InnerHTM(course_id) {\n    return new Promise(async (resolve, reject) => {\n      try {\n        const response = await get_theme_learnr_Progressbar_InnerHTML(course_id);\n        if (response && response.innerHTML) {\n          resolve(response.innerHTML);\n        } else {\n          reject(response);\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n}\n\n/**\n *\n * @param {*} innerHTML\n */\n// function modifyDOMWORKS(innerHTML) {\n//     const prcourseview = document.getElementsByClassName(selectors.progressbar.body)[0];\n//     var elementToReplace = prcourseview;\n//      // Creates additional div but the parent node might have siblings just to be safe.\n//      const newElement = document.createElement('div');\n//     newElement.innerHTML = innerHTML;\n//     const parentElement = elementToReplace.parentNode;\n//     parentElement.replaceChild(newElement, elementToReplace);\n// }\n\n\n/**\n *\n * @param {*} aselector\n */\nfunction modifyDOM(aselector) {\n    // The callback function onResolve holds the promise return value.\n    // That way the additional aselector argument mandatory for modifyDOM and the promise value are accessible.\n    return function onResolve(innerHTML) {\n        const elementToReplace = document.getElementsByClassName(aselector)[0];\n        if(elementToReplace) {\n            window.console.log(\"---modifyDOM--\", aselector);\n            // Creates an additional div but the parent node might have siblings - just to be safe.\n            const newElement = document.createElement('div');\n            newElement.innerHTML = innerHTML;\n            const parentElement = elementToReplace.parentNode;\n            parentElement.replaceChild(newElement, elementToReplace);\n        }\n    };\n  }\n\n/**\n *\n * @param {*} getinnerhtmlfunc\n * @param {*} course_id\n * @returns\n */\nasync function promise_get_InnerHTM(getinnerhtmlfunc,course_id) {\n    return new Promise(async (resolve, reject) => {\n      try {\n        const response = await getinnerhtmlfunc(course_id);\n        if (response && response.innerHTML) {\n          resolve(response.innerHTML);\n        } else {\n          reject(response);\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n}\n\n/**\n *\n * @param {*} err\n */\nfunction onError(err) {\n    window.console.log(\"--ERROR: \", err);\n}\n\nexport const changeProgressbar = () => {\n    const course_id = getCourseIdFromBody();\n    if(course_id) {\n        promise_get_InnerHTM(get_theme_learnr_Progressbar_InnerHTML,course_id)\n            .then(modifyDOM(selectors.progressbar.body))\n            .catch(onError);\n    }\n};\n\nexport const letthemagicbedone = (course_id,servicefunc,selector) => {\n        promise_get_InnerHTM(servicefunc,course_id)\n            .then(modifyDOM(selector))\n            .catch(onError);\n};\n\nexport const changeProgressbarPROMISE_PARAMS_WORKS = () => {\n    const course_id = getCourseIdFromBody();\n    if(course_id) {\n        promise_get_InnerHTM(get_theme_learnr_Progressbar_InnerHTML,course_id)\n            .then(modifyDOM)\n            .catch(onError);\n    }\n};\n\nexport const changeProgressbarPROMISEWORKS = () => {\n    const course_id = getCourseIdFromBody();\n    if(course_id) {\n        promise_get_theme_learnr_Progressbar_InnerHTM(course_id)\n            .then(modifyDOM)\n            .catch(onError);\n    }\n};\n\n/*\n* Reloads whole progressbar DOM element - it is not as smooth as just changing width.\n* On the other hand - the progress bar is correct and overall up-to-date.\n*/\nexport const changeProgressbarWORKS = async() => {\n    // ...\n    //const prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n    //const course_id = prbar.getAttribute('courseid');\n    const course_id = getCourseIdFromBody();\n    if(course_id) {\n        var response = await get_theme_learnr_Progressbar_InnerHTML(course_id);\n        if (response && response.innerHTML) {\n            window.console.log(\"lcprogessuiups-- get_theme_learnr_Progressbar_InnerHTML----response\", response);\n            var innerHTML = response.innerHTML;\n            const prcourseview = document.getElementsByClassName(selectors.progressbar.body)[0];\n            var elementToReplace = prcourseview;\n             // creates additional div but the parent node might have siblings just to be safe\n             const newElement = document.createElement('div');\n            newElement.innerHTML = innerHTML;\n            const parentElement = elementToReplace.parentNode;\n            parentElement.replaceChild(newElement, elementToReplace);\n\n        } else {\n            window.console.log(\"lcprogessuiups-- no progressbar update available\");\n        }\n        return true;\n    } else {\n        window.console.log(\"lcprogessuiups-- no course id detected\");\n        return false;\n    }\n};\n\n\n/*\n* Updates the GAME plugin interface.\n*/\nexport const changeGAME = async() => {\n    // ...\n    //const prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n    //const course_id = prbar.getAttribute('courseid');\n    const course_id = getCourseIdFromBody();\n    if(course_id) {\n        // GAME\n        var response = await get_block_Game_InnerHTML(course_id);\n         if (response && response.innerHTML) {\n            window.console.log(\"lcprogessuiups-- get_block_Game_InnerHTML----response\", response);\n             var innerHTML = response.innerHTML;\n             const prgame = document.getElementsByClassName(selectors.game.body)[0];\n             const elementToReplaceGAME = prgame.parentNode;\n             // creates additional div but the parent node might have siblings just to be safe\n             const newElementGAME = document.createElement('div');\n             newElementGAME.innerHTML = innerHTML;\n             const parentElementGAME = elementToReplaceGAME.parentNode;\n             parentElementGAME.replaceChild(newElementGAME, elementToReplaceGAME);\n\n         } else {\n             window.console.log(\"lcprogessuiups-- no game update possible\");\n             window.console.log(\"lcprogessuiups-- get_block_Game_InnerHTML----response\", response);\n         }\n        return true;\n    } else {\n        window.console.log(\"lcprogessuiups-- no course id detected\");\n        return false;\n    }\n};\n\n/*\n* Function getCmid is called from changeCompletionInfo.\n*/\nconst getCmid = (liidelement) => {\n    var courseid;\n    const attributeValue = liidelement.getAttribute('id');\n    const regex = /module-(\\d+)/;\n        const matches = attributeValue.match(regex);\n        if (matches) {\n            const courseNumber = matches[0];\n            courseid = courseNumber.split('-')[1];\n            window.console.log(\"lcprogessuiups-- cmid------\", courseid); // Output: module-341\n            return(courseid);\n        }\n  };\n\n/*\n* Updates the activity completion.\n*/\nconst changeCompletionInfo = async (event) => {\n    window.console.log('lcprogessuiups-- --changeCompletionInfo--event',event);\n    if (event && event.detail) {\n        if(event.detail.completionType && event.detail.completionType == 'H5Pscored') {\n            if(event.detail.framedin) {\n                const eventtarget = event.detail.framedin;\n                window.console.log('lcprogessuiups-- eventtarget',eventtarget);\n            // var parentElement = document.querySelector('div[data-region=\"completion-info\"] [id=\"childElementID\"]');\n                var element = eventtarget.closest('li > div');\n                const cmid = getCmid(eventtarget.closest('li'));\n                const course_id = getCourseIdFromBody();\n                const response = await get_H5P_ActivityInformation_InnerHTML(course_id, cmid);\n                window.console.log(\"lcprogessuiups-- get_H5P_ActivityInformation_InnerHTML----response\", response);\n                var element = element.querySelector(selectors.activityinfo.body);\n                //var element = element.querySelector('div[data-region=\"activity-information\"]');\n                element.innerHTML = response.innerHTML;\n            } else {\n                window.console.log(\"lcprogessuiups-- no DOM for ActivityInformation in event\");\n            }\n        } else {\n            window.console.log(\"lcprogessuiups-- no H5Pscored completionType in event\");\n        }\n    }\n    return true;\n};\n\n\n/*\n* This is the real dynprogress that calls all available UI updates.\n*/\nconst dynprbar_action = changeProgressbar;\nconst game_action = changeGAME;\nconst complinfo_action = changeCompletionInfo;\n\nexport const init = () => {\n    var prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n    const course_id = getCourseIdFromBody();\n\n    window.console.log('lcprogessuiups-- prbarneusrc' + prbar);\n    if(prbar && course_id) {\n        window.console.log('lcprogessuiups-- livecoprogressuiups----load listener');\n        listener();\n        } else {\n        window.console.log('lcprogessuiups-- livecoprogressuiups----no listeners loaded due to missing prbar');\n    }\n\n    window.addEventListener('load', function () {\n        //var pr = document.getElementsByClassName('progress')[0];\n        var prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n       // alert('pr' + pr);\n        window.console.log('lcprogessuiups-- prbarneusrc' + prbar);\n        // Add an event listener to handle the cmcompleted - send from the local_livecoprogressuiups/listener.\n        document.addEventListener('cmcompleted', function(event) {\n            window.console.log('lcprogessuiups-- cmcompleted----Custom event triggered:', event.detail.message);\n            // one option to changeProgressbar or the other 2 Variants of dynprbar_action()\n            // implement wait 300 ms - to give some time to the core events dealing with the completion\n             setTimeout(function() {\n                letthemagicbedone(course_id,get_theme_learnr_Progressbar_InnerHTML,selectors.progressbar.body);\n                //  dynprbar_action(); // The theme learnr progressbar.\n                complinfo_action(event); // The H5P completion section. Needs cmid as additional argument.\n                //  game_action(); // The GAME.\n                letthemagicbedone(course_id,get_block_Game_InnerHTML,selectors.game.body);\n            }, 300);\n        });\n    });\n};\n\nexport const initWORKING = () => {\n    var prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n\n    window.console.log('lcprogessuiups-- prbarneusrc' + prbar);\n    if(prbar) {\n        window.console.log('lcprogessuiups-- livecoprogressuiups----load listener');\n        listener();\n        } else {\n        window.console.log('lcprogessuiups-- livecoprogressuiups----no listeners loaded due to missing prbar');\n    }\n\n    window.addEventListener('load', function () {\n        //var pr = document.getElementsByClassName('progress')[0];\n        var prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n       // alert('pr' + pr);\n        window.console.log('lcprogessuiups-- prbarneusrc' + prbar);\n        // Add an event listener to handle the cmcompleted - send from the local_livecoprogressuiups/listener.\n        document.addEventListener('cmcompleted', function(event) {\n            window.console.log('lcprogessuiups-- cmcompleted----Custom event triggered:', event.detail.message);\n            // one option to changeProgressbar or the other 2 Variants of dynprbar_action()\n            // implement wait 300 ms - to give some time to the core events dealing with the completion\n             setTimeout(function() {\n                dynprbar_action(); // The theme learnr progressbar.\n                complinfo_action(event); // The H5P completion section.\n                game_action(); // The GAME.\n            }, 300);\n        });\n    });\n};"],"names":["getCourseIdFromBody","bodyTag","document","getElementsByTagName","courseid","getAttributeNames","forEach","attribute","matches","getAttribute","match","courseNumber","split","window","console","log","modifyDOM","aselector","innerHTML","elementToReplace","getElementsByClassName","newElement","createElement","parentNode","replaceChild","promise_get_InnerHTM","getinnerhtmlfunc","course_id","Promise","async","resolve","reject","response","error","onError","err","changeProgressbar","get_theme_learnr_Progressbar_InnerHTML","then","selectors","progressbar","body","catch","letthemagicbedone","servicefunc","selector","promise_get_theme_learnr_Progressbar_InnerHTM","changeGAME","elementToReplaceGAME","game","newElementGAME","dynprbar_action","game_action","complinfo_action","event","detail","completionType","framedin","eventtarget","element","closest","cmid","liidelement","getCmid","querySelector","activityinfo","prbar","addEventListener","message","setTimeout","get_block_Game_InnerHTML"],"mappings":"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"}