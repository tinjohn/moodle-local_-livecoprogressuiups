{"version":3,"file":"dynprogress.min.js","sources":["../src/dynprogress.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Dynamic Progressbar and more\n *\n * @module     local_livecoprogressuiups/dynprbar\n * @copyright  2023 Tina John <tina.john@th-luebeck.de>\n * @copyright  Institut fuer interaktive Systeme der TH LÃ¼beck\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {init as listener} from './listener';\n\nimport {get_theme_learnr_Progressbar_InnerHTML} from './local/dynprogress/repository';\nimport {get_block_Game_InnerHTML} from './local/dynprogress/repository';\nimport {get_H5P_ActivityInformation_InnerHTML} from './local/dynprogress/repository';\n\nimport selectors from 'local_livecoprogressuiups/local/dynprogress/selectors';\n\n/**\n* USED get course id from body tag.\n*/\nfunction getCourseIdFromBody() {\n    const bodyTag = document.getElementsByTagName('body')[0];\n    const attributeNames = bodyTag.getAttributeNames();\n    var courseid;\n    attributeNames.forEach(attribute => {\n        const attributeValue = bodyTag.getAttribute(attribute);\n        const regex = /course-(\\d+)/;\n        const matches = attributeValue.match(regex);\n        if (matches) {\n            const courseNumber = matches[0];\n            courseid = courseNumber.split('-')[1];\n            window.console.log(\"lcprogessuiups-- Coursenumber------\", courseid); // Output: course-64\n            return(courseid);\n        }\n    });\n    if(courseid) {\n        return(courseid);\n    } else {\n        return false;\n    }\n}\n/*\n* Reloads whole progressbar DOM element - it is not as smooth as just changing width.\n* On the other hand - the progress bar is correct and overall up-to-date.\n*/\nexport const changeProgressbar = async() => {\n    // ...\n    //const prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n    //const course_id = prbar.getAttribute('courseid');\n    const course_id = getCourseIdFromBody();\n    if(course_id) {\n        var response = await get_theme_learnr_Progressbar_InnerHTML(course_id);\n        if (response && response.innerHTML) {\n            window.console.log(\"lcprogessuiups-- get_theme_learnr_Progressbar_InnerHTML----response\", response);\n            var innerHTML = response.innerHTML;\n            const prcourseview = document.getElementsByClassName(selectors.progressbar.body)[0];\n            var elementToReplace = prcourseview;\n             // creates additional div but the parent node might have siblings just to be safe\n             const newElement = document.createElement('div');\n            newElement.innerHTML = innerHTML;\n            const parentElement = elementToReplace.parentNode;\n            parentElement.replaceChild(newElement, elementToReplace);\n\n        } else {\n            window.console.log(\"lcprogessuiups-- no progressbar update available\");\n        }\n        return true;\n    } else {\n        window.console.log(\"lcprogessuiups-- no course id detected\");\n        return false;\n    }\n};\n\n\n/*\n* Updates the GAME plugin interface.\n*/\nexport const changeGAME = async() => {\n    // ...\n    //const prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n    //const course_id = prbar.getAttribute('courseid');\n    const course_id = getCourseIdFromBody();\n    if(course_id) {\n        // GAME\n        var response = await get_block_Game_InnerHTML(course_id);\n         if (response && response.innerHTML) {\n            window.console.log(\"lcprogessuiups-- get_block_Game_InnerHTML----response\", response);\n             var innerHTML = response.innerHTML;\n             const prgame = document.getElementsByClassName(selectors.game.body)[0];\n             const elementToReplaceGAME = prgame.parentNode;\n             // creates additional div but the parent node might have siblings just to be safe\n             const newElementGAME = document.createElement('div');\n             newElementGAME.innerHTML = innerHTML;\n             const parentElementGAME = elementToReplaceGAME.parentNode;\n             parentElementGAME.replaceChild(newElementGAME, elementToReplaceGAME);\n\n         } else {\n             window.console.log(\"lcprogessuiups-- no game update possible\");\n             window.console.log(\"lcprogessuiups-- get_block_Game_InnerHTML----response\", response);\n         }\n        return true;\n    } else {\n        window.console.log(\"lcprogessuiups-- no course id detected\");\n        return false;\n    }\n};\n\n/*\n* Function getCmid is called from changeCompletionInfo.\n*/\nconst getCmid = (liidelement) => {\n    var courseid;\n    const attributeValue = liidelement.getAttribute('id');\n    const regex = /module-(\\d+)/;\n        const matches = attributeValue.match(regex);\n        if (matches) {\n            const courseNumber = matches[0];\n            courseid = courseNumber.split('-')[1];\n            window.console.log(\"lcprogessuiups-- cmid------\", courseid); // Output: module-341\n            return(courseid);\n        }\n  };\n\n/*\n* Updates the activity completion.\n*/\nconst changeCompletionInfo = async (event) => {\n    window.console.log('lcprogessuiups-- --changeCompletionInfo--event',event);\n    if (event && event.detail) {\n        if(event.detail.completionType && event.detail.completionType == 'H5Pscored') {\n            if(event.detail.framedin) {\n                const eventtarget = event.detail.framedin;\n                window.console.log('lcprogessuiups-- eventtarget',eventtarget);\n            // var parentElement = document.querySelector('div[data-region=\"completion-info\"] [id=\"childElementID\"]');\n                var element = eventtarget.closest('li > div');\n                const cmid = getCmid(eventtarget.closest('li'));\n                const course_id = getCourseIdFromBody();\n                const response = await get_H5P_ActivityInformation_InnerHTML(course_id, cmid);\n                window.console.log(\"lcprogessuiups-- get_H5P_ActivityInformation_InnerHTML----response\", response);\n                var element = element.querySelector(selectors.activityinfo.body);\n                //var element = element.querySelector('div[data-region=\"activity-information\"]');\n                element.innerHTML = response.innerHTML;\n            } else {\n                window.console.log(\"lcprogessuiups-- no DOM for ActivityInformation in event\");\n            }\n        } else {\n            window.console.log(\"lcprogessuiups-- no H5Pscored completionType in event\");\n        }\n    }\n    return true;\n};\n\n\n/*\n* This is the real dynprogress that calls all available UI updates.\n*/\nconst dynprbar_action = changeProgressbar;\nconst game_action = changeGAME;\nconst complinfo_action = changeCompletionInfo;\n\nexport const init = () => {\n    var prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n\n    window.console.log('lcprogessuiups-- prbarneusrc' + prbar);\n    if(prbar) {\n        window.console.log('lcprogessuiups-- livecoprogressuiups----load listener');\n        listener();\n        } else {\n        window.console.log('lcprogessuiups-- livecoprogressuiups----no listeners loaded due to missing prbar');\n    }\n\n    window.addEventListener('load', function () {\n        //var pr = document.getElementsByClassName('progress')[0];\n        var prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n       // alert('pr' + pr);\n        window.console.log('lcprogessuiups-- prbarneusrc' + prbar);\n        // Add an event listener to handle the cmcompleted - send from the local_livecoprogressuiups/listener.\n        document.addEventListener('cmcompleted', function(event) {\n            window.console.log('lcprogessuiups-- cmcompleted----Custom event triggered:', event.detail.message);\n            // one option to changeProgressbar or the other 2 Variants of dynprbar_action()\n            // implement wait 300 ms - to give some time to the core events dealing with the completion\n             setTimeout(function() {\n                dynprbar_action(); // The theme learnr progressbar.\n                complinfo_action(event); // The H5P completion section.\n                game_action(); // The GAME.\n            }, 300);\n        });\n    });\n};"],"names":["getCourseIdFromBody","bodyTag","document","getElementsByTagName","courseid","getAttributeNames","forEach","attribute","matches","getAttribute","match","courseNumber","split","window","console","log","changeProgressbar","async","course_id","response","innerHTML","elementToReplace","getElementsByClassName","selectors","progressbar","body","newElement","createElement","parentNode","replaceChild","changeGAME","elementToReplaceGAME","game","newElementGAME","dynprbar_action","game_action","complinfo_action","event","detail","completionType","framedin","eventtarget","element","closest","cmid","liidelement","getCmid","querySelector","activityinfo","prbar","addEventListener","message","setTimeout"],"mappings":";;;;;;;;cAmCSA,4BACCC,QAAUC,SAASC,qBAAqB,QAAQ,OAElDC,gBADmBH,QAAQI,oBAEhBC,SAAQC,kBAGbC,QAFiBP,QAAQQ,aAAaF,WAEbG,MADjB,mBAEVF,QAAS,OACHG,aAAeH,QAAQ,UAC7BJ,SAAWO,aAAaC,MAAM,KAAK,GACnCC,OAAOC,QAAQC,IAAI,sCAAuCX,UACnDA,aAGZA,WAGQ,kMAOFY,kBAAoBC,gBAIvBC,UAAYlB,yBACfkB,UAAW,KACNC,eAAiB,sDAAuCD,cACxDC,UAAYA,SAASC,UAAW,CAChCP,OAAOC,QAAQC,IAAI,sEAAuEI,cACtFC,UAAYD,SAASC,cAErBC,iBADiBnB,SAASoB,uBAAuBC,mBAAUC,YAAYC,MAAM,SAG1EC,WAAaxB,SAASyB,cAAc,OAC3CD,WAAWN,UAAYA,UACDC,iBAAiBO,WACzBC,aAAaH,WAAYL,uBAGvCR,OAAOC,QAAQC,IAAI,2DAEhB,SAEPF,OAAOC,QAAQC,IAAI,2CACZ,sDAQFe,WAAab,gBAIhBC,UAAYlB,yBACfkB,UAAW,KAENC,eAAiB,wCAAyBD,cACzCC,UAAYA,SAASC,UAAW,CACjCP,OAAOC,QAAQC,IAAI,wDAAyDI,cACvEC,UAAYD,SAASC,gBAEnBW,qBADS7B,SAASoB,uBAAuBC,mBAAUS,KAAKP,MAAM,GAChCG,WAE9BK,eAAiB/B,SAASyB,cAAc,OAC9CM,eAAeb,UAAYA,UACDW,qBAAqBH,WAC7BC,aAAaI,eAAgBF,2BAG/ClB,OAAOC,QAAQC,IAAI,4CACnBF,OAAOC,QAAQC,IAAI,wDAAyDI,iBAE1E,SAEPN,OAAOC,QAAQC,IAAI,2CACZ,wCAqDTmB,gBAAkBlB,kBAClBmB,YAAcL,WACdM,iBAhCuBnB,MAAAA,WACzBJ,OAAOC,QAAQC,IAAI,iDAAiDsB,OAChEA,OAASA,MAAMC,UACZD,MAAMC,OAAOC,gBAAiD,aAA/BF,MAAMC,OAAOC,kBACxCF,MAAMC,OAAOE,SAAU,OAChBC,YAAcJ,MAAMC,OAAOE,SACjC3B,OAAOC,QAAQC,IAAI,+BAA+B0B,iBAE9CC,QAAUD,YAAYE,QAAQ,kBAC5BC,KAzBLC,CAAAA,kBACTzC,eAGMI,QAFaqC,YAAYpC,aAAa,MAEbC,MADrB,mBAENF,eAEAJ,SADqBI,QAAQ,GACLI,MAAM,KAAK,GACnCC,OAAOC,QAAQC,IAAI,8BAA+BX,UAC3CA,UAgBU0C,CAAQL,YAAYE,QAAQ,OACnCzB,UAAYlB,sBACZmB,eAAiB,qDAAsCD,UAAW0B,MACxE/B,OAAOC,QAAQC,IAAI,qEAAsEI,WACrFuB,QAAUA,QAAQK,cAAcxB,mBAAUyB,aAAavB,OAEnDL,UAAYD,SAASC,eAE7BP,OAAOC,QAAQC,IAAI,iEAGvBF,OAAOC,QAAQC,IAAI,gEAGpB,iBAWS,SACZkC,MAAQ/C,SAASoB,uBAAuB,kCAAkC,GAE9ET,OAAOC,QAAQC,IAAI,+BAAiCkC,OACjDA,OACCpC,OAAOC,QAAQC,IAAI,+EAGnBF,OAAOC,QAAQC,IAAI,oFAGvBF,OAAOqC,iBAAiB,QAAQ,eAExBD,MAAQ/C,SAASoB,uBAAuB,kCAAkC,GAE9ET,OAAOC,QAAQC,IAAI,+BAAiCkC,OAEpD/C,SAASgD,iBAAiB,eAAe,SAASb,OAC9CxB,OAAOC,QAAQC,IAAI,0DAA2DsB,MAAMC,OAAOa,SAG1FC,YAAW,WACRlB,kBACAE,iBAAiBC,OACjBF,gBACD"}